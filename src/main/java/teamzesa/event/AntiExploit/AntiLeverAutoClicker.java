package teamzesa.event.AntiExploit;

import org.bukkit.Material;
import org.bukkit.block.Block;
import org.bukkit.entity.Player;
import org.bukkit.event.block.Action;
import org.bukkit.event.player.PlayerInteractEvent;
import teamzesa.util.Interface.EventRegister;
import teamzesa.util.Interface.StringComponentExchanger;
import teamzesa.util.Enum.ColorList;

import java.time.LocalDateTime;

public class AntiLeverAutoClicker extends StringComponentExchanger implements EventRegister {
    private Player player;
    private Action action;
    private Block clickedBlock;
    private LeverActionStatus leverActionStatus;
    private final PlayerInteractEvent event;

    public AntiLeverAutoClicker(PlayerInteractEvent event) {
        this.event = event;
        init();
        execute();
    }

    @Override
    public void init() {
        this.player = this.event.getPlayer();
        this.action = this.event.getAction();
        this.clickedBlock = this.event.getClickedBlock();
        this.leverActionStatus = LeverActionStatus.getLeverActionStatus();
    }

    @Override
    public void execute() {
        if (this.clickedBlock == null) return;

        if (this.clickedBlock.getType() != Material.LEVER) return;

        if (!(this.action.isRightClick())) return;

//        레버를 당긴 유저는 status 에 존재하는가?
        if (this.leverActionStatus.userExist(this.player)) {//존재하지 않는다면 해당유저를 추가합니다.
            this.leverActionStatus.addLeverActionEvent(this.player, LocalDateTime.now().getSecond()); //존재하지 않는다면 새로생성 후 add
            return;
        }

//        active option
        if (this.leverActionStatus.getActiveTime(this.player) != LocalDateTime.now().getSecond()) {
            this.leverActionStatus.removeStatus(this.player);
            return; //다르면 무조건 당겨짐
        }

        playerSendMsgComponentExchanger(this.player,"레버를 천천히 당겨주세요.", ColorList.RED);
        this.event.setCancelled(true);
    }
}
