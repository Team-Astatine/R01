package teamzesa.event.Restricted.AntiExploit.FloodChat;

import io.papermc.paper.event.player.AsyncChatEvent;
import net.kyori.adventure.text.TextComponent;
import org.bukkit.entity.Player;
import teamzesa.DataBase.entity.Restricted.Chat.SendChatObject;
import teamzesa.event.EventRegister.EventRegister;
import teamzesa.util.Enum.ColorMap;
import teamzesa.util.Interface.StringComponentExchanger;

public class RestrictedChatFlood extends StringComponentExchanger implements EventRegister {
    private Player player;
    private TextComponent currentChat;
    private ChatTotalStatus chatTotalStatus;

    private final AsyncChatEvent event;

    public RestrictedChatFlood(AsyncChatEvent event) {
        this.event = event;
        init();
        execute();
    }

    @Override
    public void init() {
        this.player = this.event.getPlayer();
        this.currentChat = (TextComponent) this.event.message();
        this.chatTotalStatus = ChatTotalStatus.getChatTotalStatus();
    }

    @Override
    public void execute() {
        if (this.chatTotalStatus.isExistURL(this.currentChat.content())) {
            playerSendMsgComponentExchanger(this.player, "주소를 포함한 채팅은 작성할 수 없습니다.", ColorMap.RED);
            this.event.setCancelled(true);
            return;
        }

        if (this.chatTotalStatus.isExistComment(new SendChatObject(this.player, this.currentChat.content()))) {
            playerSendMsgComponentExchanger(this.player, "같은 채팅을 두번 칠 수 없습니다.", ColorMap.RED);
            this.event.setCancelled(true);
            return;
        }

        this.chatTotalStatus.clear();
        this.chatTotalStatus.addChat(new SendChatObject(this.player, this.currentChat.content()));
    }
}
